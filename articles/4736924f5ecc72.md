---
title: "neovim 0.11ã‹ã‚‰ã¯LSPã‚’ã»ã¼ãƒã‚¤ãƒ†ã‚£ãƒ–APIã ã‘ã§æ‰±ãˆã‚‹"
emoji: "ğŸ—’ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['neovim']
published: true
---

3æœˆ26æ—¥ã€ã¤ã„ã«neovim 0.11 ãŒæ¥ã¾ã—ãŸã€‚ã“ã®ãƒªãƒªãƒ¼ã‚¹ã§ã¯ **LSPé–¢é€£æ©Ÿèƒ½ãŒå¤§å¹…ã«å¼·åŒ–ã•ã‚Œã¾ã—ãŸã€‚** ã“ã‚Œã§ã€ã„ã‚ˆã„ã‚ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãªã—ã§æœ¬æ ¼çš„ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ä»Šå›ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–APIã ã‘ã§ã©ã“ã¾ã§ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã‹ç´¹ä»‹ã—ã¾ã™ã€‚

# è¿½åŠ ã•ã‚ŒãŸLSPæ©Ÿèƒ½ä¸€è¦§

0.11 ã§è¿½åŠ ã•ã‚ŒãŸLSPé–¢é€£ã®æ©Ÿèƒ½ã¯ã“ã¡ã‚‰ã§ã™ã€‚

- language serverã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚’è¨­å®šã™ã‚‹ ([vim.lsp.config](https://neovim.io/doc/user/lsp.html#vim.lsp.config()))
- language serverã‚’è‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ ([vim.lsp.enable](https://neovim.io/doc/user/lsp.html#vim.lsp.enable()))
- LSPã‚’åˆ©ç”¨ã—ã¦è‡ªå‹•è£œå®Œã™ã‚‹  ([vim.lsp.completion](https://neovim.io/doc/user/lsp.html#lsp-completion))
- LSPé–¢é€£ã®ã‚­ãƒ¼ãƒãƒƒãƒ—ãŒè¿½åŠ ã•ã‚ŒãŸ ([DEFAULTS Mappings](https://neovim.io/doc/user/news-0.11.html#_defaults) ã‚’å‚ç…§)

ã¾ã ã¾ã ã‚ã‚‹ã®ã§ã€è©³ã—ãã¯ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚ [News-0.11](https://neovim.io/doc/user/news-0.11.html)

ã“ã‚Œã‚‰ã®APIã®ãŠã‹ã’ã§ã€**language serverè‡ªä½“ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä»¥å¤–ã¯ã»ã¼ãªã‚“ã§ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚**

# ãŠã•ã‚‰ã„: LSPé–¢é€£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŸã¡ã«ã¤ã„ã¦

ã¾ãšã¯0.11ã¾ã§ã»ã¼å¿…é ˆã ã£ãŸLSPãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŸã¡ã‚’ãŠã•ã‚‰ã„ã—ã¦ã„ãã¾ã™ã€‚çŸ¥ã£ã¦ã„ãŸã‚‰æ¬¡ã®ç« ã¾ã§é£›ã°ã—ã¦ã‚ˆã„ã§ã™ã€‚

- **nvim-lspconfig**: ã‚³ãƒ³ãƒ•ã‚£ã‚°é›†ã€‚0.11ä»¥å‰ã¯language serverã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚æ‹…å½“ã—ã¦ã„ãŸã€‚
- **mason**: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ„ãƒ¼ãƒ«ã‚’ç®¡ç†ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚language serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‹…å½“ã™ã‚‹ã€‚linterã‚„formatterã‚‚ã¾ã¨ã‚ã¦ç®¡ç†ã§ãã‚‹ã€‚
- **mason-lspconfig**: nvim-lspconfig ã®è¨­å®šã‚’åˆ©ç”¨ã—ã¦language serverã®èµ·å‹•ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚masonã‚’ä»‹ã—ãŸlanguage serverã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã€‚

# 0.11ä»¥å‰ã¨0.11ä»¥é™ã®æ›¸ãæ–¹ã®é•ã„

0.11ä»¥å‰ã§language serverã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã™ã‚‹è¨­å®šã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```lua
-- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼(mason)ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
require 'mason'.setup()

-- masonã‚’ä»‹ã—ã¦language serverã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
local mason_lspconfig = require 'mason-lspconfig'
mason_lspconfig.setup {
  automatic_installation = true,
  ensure_installed = {'ts_ls', 'lua_ls'}, -- è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„language server
}

-- language serverã®è¨­å®šã‚’ã™ã‚‹
local lspconfig = require 'lspconfig'
mason_lspconfig.setup_handlers {
  function(server_name)
    lspconfig[server_name].setup {}
  end,
  -- nvim-lspconfig ã®è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒ ã—ã¤ã¤ä½¿ã†
  lua_ls = function()
    lspconfig.lua_ls.setup {
      settings = {
        Lua = {
          diagnostics = {
            globals = { 'vim' }
          },
        }
      },
    }
  end
}
```

åŒã˜ã“ã¨ã‚’ã™ã‚‹0.11ä»¥é™ã®è¨­å®šã¯ã“ã¡ã‚‰ã§ã™ã€‚

```lua
-- (åŒã˜) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼(mason)ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
require 'mason'.setup()

-- (åŒã˜) masonã‚’ä»‹ã—ã¦language serverã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
local ensure_installed = {'ts_ls', 'lua_ls'}
require 'mason-lspconfig'.setup {
  automatic_installation = true,
  ensure_installed = ensure_installed, -- è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„language server
}

-- (NEW) language serverã®è¨­å®šã‚’ã™ã‚‹
vim.lsp.config('lua_ls', {
  -- nvim-lspconfig ãŒè¨­å®šã—ãŸã‚³ãƒ³ãƒ•ã‚£ã‚°ã«settingsã‚’è¿½åŠ ã™ã‚‹
  settings = {
    Lua = {
      diagnostics = {
        globals = { 'vim' }
      },
    }
  },
})
vim.lsp.enable(ensure_installed)
```

é•ã†ã®ã¯æœ€å¾Œã®language serverã‚’è¨­å®šã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚nvim-lspconfigã¯ã‚³ãƒ³ãƒ•ã‚£ã‚°é›†ã¨ã—ã¦ã ã‘ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã€ **neovimã®APIã ã‘ã§è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚**

ã“ã®ã‚ˆã†ã«ã€masonã‚’ä½¿ã£ãŸlanguage serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä»¥å¤–ã¯ **ã»ã¨ã‚“ã©neovimã®APIã ã‘ã§å®Œçµã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚**

# LSPã‚’ä½¿ã£ãŸè‡ªå‹•è£œå®ŒãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ

0.11ã§ã¯ **LSPã‚’ä½¿ã£ãŸè£œå®Œã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚** ã‚ªãƒ ãƒ‹è£œå®Œ(`<C-x><C-o>`)ã ã‘ã§ãªãã€ã‚­ãƒ¼å…¥åŠ›ä¸­ã®è£œå®Œã‚‚ä½¿ãˆã¾ã™ã€‚ autotriggerã‚’trueã«è¨­å®šã™ã‚‹ã ã‘ã§å‡ºæ¥ã¾ã™ã€‚

```lua
vim.cmd[[set completeopt+=menuone,noselect,popup]]
vim.lsp.start({
  name = 'ts_ls',
  cmd = â€¦,
  on_attach = function(client, bufnr)
    vim.lsp.completion.enable(true, client.id, bufnr, {
      autotrigger = true, -- è‡ªå‹•è£œå®Œã‚’æœ‰åŠ¹ã«ã™ã‚‹
      convert = function(item)
        return { abbr = item.label:gsub('%b()', '') }
      end,
    })
  end,
})
```

å‚è€ƒ: [Lua module: vim.lsp.completion](https://neovim.io/doc/user/lsp.html#lsp-completion)

autotriggerã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€æŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã«LSPã‚’ä½¿ã£ãŸè£œå®ŒãŒå‡ºã¦ãã¾ã™ã€‚

![](/images/auto-completion.png)

çµæ§‹ã¡ã‚ƒã‚“ã¨å‹•ãã®ã§ã€è£œå®Œç³»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ç„¡ãã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# ã¾ã¨ã‚: ã»ã¼ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãªã—ã§LSPã‚’ä½¿ã†æº–å‚™ãŒæ•´ã£ãŸ

0.11ã§å…¥ã£ãŸæ©Ÿèƒ½ã«ã‚ˆã‚Šã€å®Ÿã«æ§˜ã€…ãªã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

- language serverã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚’è¨­å®šã™ã‚‹
- language serverã‚’è‡ªå‹•çš„ã«èµ·å‹•ã•ã›ã‚‹
- LSPã‚’ä½¿ã£ãŸè‡ªå‹•è£œå®Œã‚’ä½¿ã†

language serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯å¯¾å¿œã—ã¦ãªã„ã®ã§ã€ã¾ã masonã¯ã‚ã£ãŸã»ã†ãŒä¾¿åˆ©ã§ã™ã€‚ã—ã‹ã—ã€nvim-lspconfigã¯ã»ã¼ã‚³ãƒ³ãƒ•ã‚£ã‚°é›†ã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‹ãªã‚Šå¬‰ã—ã„ã§ã™ã­ã€‚

ä¸è¦ã«ãªã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚å¢—ãˆãŸã®ã§ã€ã“ã®æ©Ÿä¼šã«dotfilesã‚’è¦‹ç›´ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ã€‚

# å‚è€ƒ

- [News-0.11](https://neovim.io/doc/user/news-0.11.html#_defaults)
- [What's New in Neovim 0.11](https://gpanders.com/blog/whats-new-in-neovim-0-11/)
